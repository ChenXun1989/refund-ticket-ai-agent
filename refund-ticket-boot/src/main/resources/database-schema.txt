#================================================================================
退票AI智能体系统 - 数据库结构文档
================================================================================

【数据库基本信息】
  数据库名称: refund_ticket
  字符集: utf8mb4
  排序规则: utf8mb4_unicode_ci
  数据库引擎: InnoDB

================================================================================
一、数据表结构说明
================================================================================

--------------------------------------------------------------------------------
1. 购票记录表 buy_ticket
--------------------------------------------------------------------------------

【表基本信息】
  表名: buy_ticket
  用途: 存储用户购买电影票的完整记录信息
  引擎: InnoDB
  字符集: utf8mb4

【字段详细说明】

  字段: id
    数据类型: BIGINT
    约束条件: PRIMARY KEY, AUTO_INCREMENT
    字段说明: 主键ID，自动递增

  字段: code
    数据类型: VARCHAR(64)
    约束条件: NOT NULL, UNIQUE
    字段说明: 购票编号，唯一标识一次购票

  字段: user_name
    数据类型: VARCHAR(100)
    约束条件: NOT NULL
    字段说明: 用户名，购票人姓名

  字段: ticket_price
    数据类型: DECIMAL(10, 2)
    约束条件: NOT NULL
    字段说明: 票价，精确到分

  字段: cinema_name
    数据类型: VARCHAR(200)
    约束条件: NOT NULL
    字段说明: 影院名称，包含具体门店信息

  字段: movie_name
    数据类型: VARCHAR(200)
    约束条件: NOT NULL
    字段说明: 电影名称

  字段: ticket_time
    数据类型: DATETIME
    约束条件: NOT NULL
    字段说明: 购票时间，用户实际购票的时间戳

  字段: create_time
    数据类型: DATETIME
    约束条件: NOT NULL, DEFAULT CURRENT_TIMESTAMP
    字段说明: 记录创建时间，自动生成

  字段: update_time
    数据类型: DATETIME
    约束条件: NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    字段说明: 记录更新时间，自动维护

【索引信息】
  主键索引: id
  唯一索引: uk_code (code) - 确保购票编号唯一
  普通索引: idx_user_name (user_name) - 提升按用户查询性能
  普通索引: idx_ticket_time (ticket_time) - 提升按时间查询性能

【业务规则】
  规则1: 购票编号code格式为 BT + 日期 + 序号，例如 BT20231201001
  规则2: 票价ticket_price为正数，精确到小数点后2位
  规则3: 影院名称cinema_name包含影院品牌和具体门店位置
  规则4: 购票时间ticket_time记录用户下单购票的时刻

【数据示例】
  购票编号: BT20231201001
  用户名: 张三
  票价: 58.00元
  影院: 万达影城(王府井店)
  电影: 长津湖之水门桥
  购票时间: 2023-12-01 14:30:00

--------------------------------------------------------------------------------
2. 退票记录表 refund_ticket
--------------------------------------------------------------------------------

【表基本信息】
  表名: refund_ticket
  用途: 存储用户退票申请及处理状态信息
  引擎: InnoDB
  字符集: utf8mb4

【字段详细说明】

  字段: id
    数据类型: BIGINT
    约束条件: PRIMARY KEY, AUTO_INCREMENT
    字段说明: 主键ID，自动递增

  字段: buy_ticket_code
    数据类型: VARCHAR(64)
    约束条件: NOT NULL
    字段说明: 关联的购票编号，外键关联buy_ticket表

  字段: code
    数据类型: VARCHAR(64)
    约束条件: NOT NULL, UNIQUE
    字段说明: 退票编号，唯一标识一次退票申请

  字段: user_name
    数据类型: VARCHAR(100)
    约束条件: NOT NULL
    字段说明: 用户名，申请退票的用户姓名

  字段: status
    数据类型: VARCHAR(20)
    约束条件: NOT NULL
    字段说明: 退票状态，见下方状态枚举值说明

  字段: create_time
    数据类型: DATETIME
    约束条件: NOT NULL, DEFAULT CURRENT_TIMESTAMP
    字段说明: 记录创建时间，退票申请提交时间

  字段: update_time
    数据类型: DATETIME
    约束条件: NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    字段说明: 记录更新时间，状态变更时自动更新

【退票状态枚举值】
  PENDING: 待处理 - 退票申请已提交，等待系统处理
  PROCESSING: 处理中 - 系统正在处理退票申请
  APPROVED: 已通过 - 退票申请已批准，退款将原路返回
  REJECTED: 已拒绝 - 退票申请被拒绝，不符合退票条件

【索引信息】
  主键索引: id
  唯一索引: uk_code (code) - 确保退票编号唯一
  普通索引: idx_buy_ticket_code (buy_ticket_code) - 提升关联购票记录查询性能
  普通索引: idx_user_name (user_name) - 提升按用户查询性能
  普通索引: idx_status (status) - 提升按状态查询性能

【业务规则】
  规则1: 退票编号code格式为 RT + 日期 + 序号，例如 RT20231201001
  规则2: buy_ticket_code必须对应buy_ticket表中的有效购票编号
  规则3: 同一个购票编号可以有多次退票申请记录
  规则4: status状态流转顺序为 PENDING -> PROCESSING -> APPROVED/REJECTED
  规则5: user_name应与对应购票记录中的用户名一致

【数据示例】
  退票编号: RT20231201001
  购票编号: BT20231201001
  用户名: 张三
  状态: PENDING(待处理)
  创建时间: 2023-12-01 15:00:00

================================================================================
二、表关系说明
================================================================================

【主要关联关系】
  关联字段: refund_ticket.buy_ticket_code 关联 buy_ticket.code
  关系类型: 一对多关系
  关系说明: 一条购票记录buy_ticket可以对应多条退票记录refund_ticket

【数据完整性约束】
  约束1: 购票记录是退票的前置条件
  约束2: 退票记录通过buy_ticket_code字段关联到具体的购票记录
  约束3: 删除购票记录前需要先处理相关的退票记录

================================================================================
三、常见查询场景
================================================================================

【场景1】查询用户的所有购票记录
  查询目的: 获取指定用户的购票历史
  查询条件: user_name = '张三'
  涉及表: buy_ticket
  索引优化: 使用idx_user_name索引

【场景2】查询待处理的退票申请
  查询目的: 获取所有待处理的退票申请
  查询条件: status = 'PENDING'
  涉及表: refund_ticket
  索引优化: 使用idx_status索引

【场景3】查询用户的退票历史及对应购票信息
  查询目的: 获取用户的完整退票记录，包含原购票详情
  查询条件: user_name = '张三'
  涉及表: refund_ticket JOIN buy_ticket
  关联条件: refund_ticket.buy_ticket_code = buy_ticket.code
  索引优化: 使用idx_user_name和idx_buy_ticket_code索引

【场景4】按时间范围查询购票记录
  查询目的: 获取指定时间段内的购票记录
  查询条件: ticket_time BETWEEN '2023-12-01' AND '2023-12-31'
  涉及表: buy_ticket
  索引优化: 使用idx_ticket_time索引

================================================================================
四、AI处理建议
================================================================================

【数据识别要点】
  识别点1: 购票编号识别 - 以BT开头的编号为购票编号
  识别点2: 退票编号识别 - 以RT开头的编号为退票编号
  识别点3: 状态判断 - 根据status字段值判断退票处理进度
  识别点4: 时间关联 - create_time记录创建时间，update_time记录最后修改时间

【业务逻辑理解】
  逻辑1: 退票必须基于有效的购票记录
  逻辑2: 退票状态有明确的生命周期，待处理 -> 处理中 -> 已通过/已拒绝
  逻辑3: 同一购票可能有多次退票申请，例如部分退票、重复申请等
  逻辑4: user_name字段在两个表中应保持一致性

【数据验证规则】
  验证1: 购票编号和退票编号必须唯一
  验证2: 票价必须为正数
  验证3: 退票的buy_ticket_code必须在buy_ticket表中存在
  验证4: status只能是PENDING、PROCESSING、APPROVED、REJECTED四个枚举值之一
  验证5: 时间字段应符合DATETIME格式，格式为 YYYY-MM-DD HH:MM:SS

================================================================================
五、数据库设计特点
================================================================================

【设计优点】
  优点1: 字符集支持 - 使用utf8mb4支持emoji和特殊字符
  优点2: 时间自动维护 - create_time和update_time自动维护，减少人工错误
  优点3: 索引优化 - 针对常见查询场景建立了合理的索引
  优点4: 数据完整性 - 通过唯一索引保证编号唯一性
  优点5: 注释完整 - 每个字段都有详细的中文注释

【扩展性考虑】
  考虑1: 主键使用BIGINT支持大数据量
  考虑2: VARCHAR长度预留充足空间
  考虑3: DECIMAL精度适合金额计算
  考虑4: 状态字段使用VARCHAR便于扩展新状态

================================================================================
